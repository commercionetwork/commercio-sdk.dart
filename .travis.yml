os: linux
language: shell
jobs:
  include:

    ## ----------------------------------------
    ## --- Steps to test and build the code
    ## ----------------------------------------

    - language: dart
      jobs:
      include:
      # Check that everything analyzes properly and is formatted.
      - stage: analyze_and_format
        script:
          - pub run build_runner build
          - dartanalyzer --fatal-warnings .
          - dartfmt -n --set-exit-if-changed .
      # Build the entire `test` directory
      - stage: build
        script:
          - pub run build_runner build test
      # Set up several jobs in the next stage, using the built in sharding
      # feature from the `test` package.
      - stage: unit_test
        script:
          - pub run build_runner test -- --total-shards 4 --shard-index 0
      - stage: unit_test
        script:
          - pub run build_runner test -- --total-shards 4 --shard-index 1
      - stage: unit_test
        script:
          - pub run build_runner test -- --total-shards 4 --shard-index 2
      - stage: unit_test
        script:
          - pub run build_runner test -- --total-shards 4 --shard-index 3
      # Specify the ordering of your stages
      stages:
        - analyze_and_format
        - build
        - unit_test

    ## ----------------------------------------------------
    ## --- Steps to build and publish the documentation
    ## ----------------------------------------------------

    - language: node_js
      if: branch != gh-pages
      node_js:
        - lts/*

      install:
        - npm ci

      script:
        - npm run docs:build
        - echo 'dart.sdk.docs.commercio.network' > docs/.vuepress/dist/CNAME

      deploy:
        provider: pages
        cleanup: false
        local_dir: docs/.vuepress/dist
        token: $GITHUB_TOKEN
        keep_history: true
        on:
          tags: true
